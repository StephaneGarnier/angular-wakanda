/*! angular-wakanda - v0.3.0 - 2014-06-24 */!function(a,b){function c(a){var b=new Date;return b.setISO(a),b}function d(a){if(null==a||""==a)return null;var b=a.split("!");return b.length<3?null:new Date(Number(b[2]),Number(b[1])-1,Number(b[0]))}b["true"]=a;var e;!function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;e=function(){},e.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}();var f={core:{},config:{}};Date.prototype.toJSON=function(){return this.toISO()+","+this.toSimpleDateString()},Date.prototype.toSimpleDateString=function(){return""+this.getDate()+"!"+(this.getMonth()+1)+"!"+(this.getYear()+1900)},Date.prototype.setISO=function(a){var b="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",c=a.match(new RegExp(b)),d=0,e=new Date(c[1],0,1);c[3]&&e.setMonth(c[3]-1),c[5]&&e.setDate(c[5]),c[7]&&e.setHours(c[7]),c[8]&&e.setMinutes(c[8]),c[10]&&e.setSeconds(c[10]),c[12]&&e.setMilliseconds(1e3*Number("0."+c[12])),c[14]&&(d=60*Number(c[16])+Number(c[17]),d*="-"==c[15]?1:-1),d-=e.getTimezoneOffset(),time=Number(e)+60*d*1e3,this.setTime(Number(time))},Date.prototype.toISO=function(a,b){if(!a)var a=6;if(b){var c=b.match(/([-+])([0-9]{2}):([0-9]{2})/),d=60*Number(c[2])+Number(c[3]);d*="-"==c[1]?-1:1;var e=new Date(Number(Number(this)+6e4*d))}else var b="Z",e=this;var f=function(a){return(10>a?"0":"")+a},g="";if(g+=e.getUTCFullYear(),a>1&&(g+="-"+f(e.getUTCMonth()+1)),a>2&&(g+="-"+f(e.getUTCDate())),a>3&&(g+="T"+f(e.getUTCHours())+":"+f(e.getUTCMinutes())),a>5){var h=Number(e.getUTCSeconds()+"."+(e.getUTCMilliseconds()<100?"0":"")+f(e.getUTCMilliseconds()));g+=":"+f(h)}else a>4&&(g+=":"+f(e.getUTCSeconds()));return a>3&&(g+=b),g},Date.prototype.isValid=function(){return!isNaN(this.getTime())},f.core.restConnect={},f.core.restConnect.httpMethods={_post:"POST",_get:"GET",_put:"PUT",_delete:"DELETE"},f.core.restConnect.restActions={_retrieve:"retrieve",_create:"create",_update:"update",_delete:"delete"},f.core.restConnect.queryOptions={_expand:"$expand",_orderby:"$orderby",_skip:"$skip",_top:"$top",_filter:"$filter"},f.core.restConnect.filterOperators={_equal:"eq",_notequal:"neq",_greaterthan:"gt",_greaterthanorequal:"gteq",_lessthan:"lt",_lessthanorequal:"lteq",_logicaland:"and",_logicalor:"or",_logicalnot:"not"},f.core.restConnect.filterArithmeticOperators={_add:"add",_sub:"sub",_mul:"mul",_div:"div",_mod:"mod"},f.core.restConnect.defaultService="rest",f.core.restConnect.standardErrors={_hostnamemissing:{key:"1",string:"The hostname is missing."},_servicemissing:{key:"2",string:"The service is missing."},_httpmethodundefined:{key:"3",string:"The HTTP method is undefined."},_wronghttpmethod:{key:"4",string:"The HTTP method get doesn't support POST data."}},f.core.restConnect.getXMLHttpRequest=function(){var a=!1;return window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject,a},f.core.restConnect.restRequest=function(a){this.connectionMode=a,this.fullURL=null,this.httpMethod=f.core.restConnect.httpMethods._get,this.hostname="",this.app=f.config.pattern,this.service=f.core.restConnect.defaultService,this.resource="",this.attributesRequested=void 0,this.keys=[],this.expand=[],this.orderby=[],this.skip=null,this.top=null,this.filter=null,this.method=null,this.metadata=null,this.handler=null,this.postdata=null,this.queryPlan=null,this.progressInfo=null,this.distinct=!1,this.refreshOnly=!1,this.error={key:0,string:""},this.orderByArgsToString=function(){var a="";if("string"==typeof this.orderby)return this.orderby;this.orderby.length>0&&(a=this.orderby[0]);for(var b=1;b<this.orderby.length;b++)a+=","+this.orderby[b];return a},this.go=function(a){var b=this.handler,c="/";if(null!=this.app&&(c+=this.app+"/"),""===this.service)return this.error=f.core.restConnect.standardErrors._servicemissing,!1;if(c+=this.service+"/",""!==this.resource&&(c+=this.resource+"/",this.keys.length>0)){c+="(";for(var d=0;d<this.keys.length;d++)c+=this.keys[d],d<this.keys.length-1&&(c+=",");c+=")"}var e=!1;this.dataURI&&(c=this.dataURI,e=-1!==c.indexOf("?"),e||(c+="/"));var g=!e;if(void 0!=this.attributesRequested){if(this.attributesRequested.length>0){c+=this.attributesRequested[0];for(var d=1;d<this.attributesRequested.length;d++)c+=","+this.attributesRequested[d]}c+="/"}var h="";if(this.skip&&(h+=(e?"&$skip=":"$skip=")+this.skip,e=!0),this.top&&(h+=(e?"&$top=":"$top=")+this.top,e=!0),this.filter&&(h+=(e?"&$filter=":"$filter=")+encodeURIComponent("'"+this.filter+"'"),e=!0),this.params&&(h+=(e?"&$params=":"$params=")+encodeURIComponent("'"+JSON.stringify(this.params)+"'"),e=!0),this.method&&(h+=(e?"&$method=":"$method=")+this.method,e=!0),this.asArray&&(h+=(e?"&$asArray=":"$asArray=")+"true",e=!0),this.metadata&&(h+=(e?"&$metadata=":"$metadata=")+this.metadata,e=!0),this.distinct&&(h+=(e?"&$distinct=":"$distinct=")+this.distinct,e=!0),null!=this.findKey&&(h+=(e?"&$findKey=":"$findKey=")+encodeURIComponent(""+this.findKey),e=!0),this.queryPlan&&(h+=e?"&$queryplan=true&querypath=true":"$queryplan=true&querypath=true",e=!0),this.progressInfo&&(h+=(e?"&$progressinfo=":"$progressinfo=")+encodeURIComponent(this.progressInfo),e=!0),this.timeout&&(h+=(e?"&$timeout=":"$timeout=")+this.timeout,e=!0),this.savedQueryString&&(h+=(e?"&$savedfilter=":"$savedfilter=")+encodeURIComponent("'"+this.savedQueryString+"'"),e=!0),this.savedOrderby&&(h+=(e?"&$savedorderby=":"$savedorderby=")+this.savedOrderby,e=!0),this.refreshOnly&&(h+=(e?"&$refresh=":"$refresh=")+this.refreshOnly,e=!0),this.atOnce&&(h+=(e?"&$atOnce=":"$atOnce=")+this.atOnce,e=!0),this.retainPositions&&(h+=(e?"&$retainPositions=":"$retainPositions=")+this.retainPositions,e=!0),null!=this.removeAtPos&&(h+=(e?"&$removeFromSet=":"$removeFromSet=")+this.removeAtPos,e=!0),null!=this.removeReferenceOnly&&(h+=(e?"&$removeRefOnly=":"$removeRefOnly=")+this.removeReferenceOnly,e=!0),null!=this.filterAttributes&&(h+=(e?"&$attributes=":"$attributes=")+encodeURIComponent(this.filterAttributes),e=!0),null!=this.addToSet&&(h+=(e?"&$addToSet=":"$addToSet=")+encodeURIComponent("'"+JSON.stringify(this.addToSet)+"'"),e=!0),null!=this.fromSelection&&(h+=(e?"&$fromSel=":"$fromSel=")+encodeURIComponent("'"+JSON.stringify(this.fromSelection)+"'"),e=!0),null!=this.keepSelection&&(h+=(e?"&$keepSel=":"$keepSel=")+encodeURIComponent("'"+JSON.stringify(this.keepSelection)+"'"),e=!0),this.orderby&&this.orderby.length&&(h+=e?"&$orderby="+this.orderByArgsToString():"$orderby="+this.orderByArgsToString(),e=!0),null!=this.subOrderby&&(h+=(e?"&$subOrderby=":"$subOrderby=")+encodeURIComponent(this.subOrderby),e=!0),void 0!=this.attributesExpanded&&this.attributesExpanded.length>0){var i="";h+=e?"&$expand=":"$expand=",e=!0;for(var d=0;d<this.attributesExpanded.length;d++)i+=""===i?this.attributesExpanded[d]:","+this.attributesExpanded[d];h+=i}null!=this.autoExpand&&""!=this.autoExpand&&(h+=e?"&$expand=":"$expand=",e=!0,h+=this.autoExpand),null!=this.autoSubExpand&&""!=this.autoSubExpand&&(h+=e?"&$subExpand=":"$subExpand=",e=!0,h+=this.autoSubExpand),""!==h&&(g&&(c+="?"),c+=h);var j="";if(""!==this.httpMethod?j=this.httpMethod:this.error=f.core.restConnect.httpMethods._get,this.postdata&&j==f.core.restConnect.httpMethods._get)return this.error=f.core.restConnect.standardErrors._wronghttpmethod,!1;if(this.http_request=f.core.restConnect.getXMLHttpRequest(),this.http_request){if(this.http_request.parent=this,a&&a.generateRESTRequestOnly)return c;null!=b&&(this.http_request.onreadystatechange=function(){b(this.parent)});try{return this.fullURL&&(c=this.fullURL),this.http_request.open(j,c,this.connectionMode),this.postdata&&this.http_request.setRequestHeader("Content-Type","application/json"),this.http_request.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),this.http_request.setRequestHeader("Cache-Control","no-cache"),this.http_request.send(this.postdata),this.connectionMode||b(this.http_request),!0}catch(k){return!0}return!1}}},f.callHandler=function(a,b,c,d,e){var f=null;if(c.userData=e,a){var g=d.onError;c.error=b,null!=g&&(f=g(c))}else{var h=d.onSuccess;null!=h&&(f=h(c))}return f},f.getRequestResult=function(a){var b,c=a.http_request.responseText;if(null==c)b={__ERROR:[{errCode:-1}]};else try{b=JSON.parse(c)}catch(d){b={__ERROR:[d]}}return b},f.tools={},f.tools.optionMatchers=["onSuccess","onError","atTheEnd","sync","autoExpand","autoSubExpand","catalog","queryString","skip","top","position","orderby","orderBy","params","queryPlan","queryPath","pageSize","filterSet","progressInfo","progressBar","delay","delayInfo","method","first","limit","userData","addToSet","atOnce","refreshOnly","keepOldCollectionOnError","isMethodResult","prefetchedData","callWithGet","generateRESTRequestOnly","forceReload","doNotAlterElemPos","overrideStamp","queryParams","createEmptyCollection","forceCollectionRefresh","refreshCollectionFrom","removeReferenceOnly","timeout","doNotDispatch","destinationDataSource","filterAttributes","subOrderby","filterQuery","withinCollection","keepOrderBy","retainPositions","fromInitialQuery"],f.tools.isOptionParam=function(a){var b=!1;if(null!=a&&"object"==typeof a)for(var c=f.tools.optionMatchers,d=c.length,e=0;d>e&&!b;++e){var g=c[e];if(g in a){b=!0;break}}return b},f.tools.handleArgs=function(a,b,c){var d=!1;c=c||{},b=b||0;var e,g=c.noUserData||!1,h=c.with3funcs||!1,i=c.queryParams||!1,j={options:{},userData:null},k=a.length,l=b;k>l&&(e=a[l],"function"==typeof e&&(j.options.onSuccess=e,++l,k>l&&(e=a[l],"function"==typeof e&&(j.options.onError=e,++l,k>l&&(e=a[l],h&&"function"==typeof e&&(j.options.atTheEnd=e,++l)))),null==j.options.onError&&(j.options.onError=j.options.onSuccess)));var m=null;i&&(m=[]);do if(k>l)if(e=a[l],!d&&f.tools.isOptionParam(e)){d=!0,++l;var n=j.options;j.options=e,null!=n.onSuccess&&(j.options.onSuccess=n.onSuccess),null!=n.onError&&(j.options.onError=n.onError),null!=n.atTheEnd&&(j.options.atTheEnd=n.atTheEnd),i||k>l&&!g&&(j.userData=a[l],++l)}else i&&("object"!=typeof e||e instanceof Date||e instanceof Array?(m.push(e),++l):(j.userData=e,++l));while(i&&k>l);return null!=j.options.userData&&null==j.userData&&(j.userData=j.options.userData),i&&(j.options.params=j.options.params||m),j.nextParam=l,j},f.EntityCache=function(a){a=a||{};this.maxEntities=a.maxEntities||300,this.timeOut=a.timeOut||3e5,this.entitiesByKey={},this.nbEntries=0,this.curStamp=0},f.EntityCache.prototype.getNextStamp=function(){var a=this;return a.curStamp++,a.curStamp},f.EntityCache.prototype.clear=function(a){var b=this;if(null==a||a>=b.nbEntries)b.entitiesByKey={},b.nbEntries=0;else{var c=[],d=b.entitiesByKey;for(var e in d)c.push(d[e]);c.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1});var f=a;f>c.length&&(f=c.length);for(var g=b.nbEntries,h=0;f>h;h++){var i=c[h];delete d[i.key],--g}b.nbEntries=g,delete c}},f.EntityCache.prototype.makeRoomFor=function(a){var b=this;b.maxEntities<2*a&&(b.maxEntities=2*a);var c=b.maxEntities-b.nbEntries;a>c&&b.clear(a-c)},f.EntityCache.prototype.setEntry=function(a,b,c){var d=this,e=d.entitiesByKey,f=e[a];null==f&&(d.nbEntries>=d.maxEntities&&d.clear(Math.round(d.nbEntries/3)),d.nbEntries++);var g=d.getNextStamp();return e[a]={key:a,timeStamp:c,rawEntity:b,stamp:g},g},f.EntityCache.prototype.getCacheInfo=function(a){var b=this,c=b.entitiesByKey[a];return c},f.EntityCache.prototype.replaceCachedEntity=function(a,b){var c=this,d=c.entitiesByKey[a];null!=d&&(d.timeStamp=new Date,d.rawEntity=b,d.stamp=c.getNextStamp())},f.EntityCache.prototype.removeCachedEntity=function(a){var b=this,c=b.entitiesByKey[a];null!=c&&delete b.entitiesByKey[a]},f.EntityCache.prototype.setSize=function(a){(null==a||300>a)&&(a=300),this.maxEntities=a},f.DataStore=function(a,b){a=a||{},b=b;var c=this;this._private={owner:this,dataClasses:{},dataClassesByCollectionName:{},ready:!1,getCatalog:f.DataStore.getCatalog},c._private.getCatalog(a,b)},f.DataStore.prototype.getDataClass=function(a){var b=this._private,c=b.dataClasses[a];return null==c&&(c=b.dataClassesByCollectionName[a]),c},f.DataStore.prototype.getDataClasses=function(){var a=this._private;return a.dataClasses},f.DataStore.prototype.addToCatalog=function(a,b,c){c=c||null,b=b||{};var d=this._private;b.catalog=a,b.mergeCatalog=!0,d.getCatalog(b,c)},f.DataStore.resolveRelatedAttribute=function(){if(!this.resolved){var a=this.owner.getDataStore();this.relatedClass=a.getDataClass(this.type),null!=this.relatedClass&&(this.resolved=!0)}},f.DataStore.getRelatedClassAttribute=function(){return this.resolve(),this.relatedClass},f.DataStore.handleFuncResult=function(a,b,c){var d=f.getRequestResult(a);if(null==d.__ERROR)if(null!=d.__entityModel&&(c=c.getDataStore().getDataClass(d.__entityModel)),null!=d.__KEY||null!=d.__STAMP){var e=new f.Entity(c,d);d={result:e}}else if(null!=d.__ENTITIES){var g=new f.EntityCollection(c,null,{prefetchedData:d,isMethodResult:!0});d={result:g}}return d},f.DataStore.funcCaller=function(a,b,c,d){var e=null;d=d||{};var g=d.sync||!1,h=a.callWithGet||d.callWithGet||!1,i=d.generateRESTRequestOnly||!1,j=new f.core.restConnect.restRequest(!g);j.httpMethod=h?f.core.restConnect.httpMethods._get:f.core.restConnect.httpMethods._post;var k=null,l=null,m=null,n=JSON.stringify(c);if(h?j.params=c:j.postdata=n,"entity"==a.applyTo){k=b,l=k.getDataClass(),j.attributesRequested=[a.name],j.resource=l.getName()+"(";var o=k.getKey();null!=o&&(j.resource+=o),j.resource+=")"}else"entityCollection"==a.applyTo?(m=b,l=m.getDataClass(),null!=m._private.dataURI?j.dataURI=m._private.dataURI+"/"+a.name:(j.attributesRequested=[a.name],j.resource=l.getName(),j.filter=d.queryString),m._private.updateOptions(d)):"general"==a.applyTo?(j.resource=a.nameSpace,j.attributesRequested=[a.name]):(l=b,j.attributesRequested=[a.name],j.resource=l.getName());var p=d.pageSize||40;if(j.top=p,j.method="entityset",j.timeout=300,j.addToSet=d.addToSet,null!=d.autoExpand&&(j.autoExpand=d.autoExpand),null!=d.filterAttributes&&(j.filterAttributes=d.filterAttributes),g||(j.handler=function(){if(4==j.http_request.readyState){var b=f.DataStore.handleFuncResult(j,a,l),c={result:b.result},e=b.__ERROR,g=d.userData||null;c.XHR=j.http_request,f.callHandler(null!=e,e,c,d,g)}}),i)e=j.go({generateRESTRequestOnly:!0});else if(j.go(),g){var q,r;if(q=function(){},r=function(){},c.length>0&&(c[0]&&"function"==typeof c[0]&&(q=c[0]),c[1]&&"function"==typeof c[1]&&(r=c[1])),4!=j.http_request.readyState)throw{error:401};var s=f.DataStore.handleFuncResult(j,a,l);if(null!=s.__ERROR)throw r(s),s.__ERROR;e=s.result,q(e)}return e},f.DataStore.callMethod=function(a){var b=null,c=this,d=c._private.dataClassMethodRefs[a.method];if(null!=d){var e=[];if(null!=a.arguments)e=a.arguments;else for(var g=1,h=arguments.length;h>g;g++)e.push(arguments[g]);b=f.DataStore.funcCaller(d,c,e,a)}return b},f.DataStore.makeFuncCaller=function(a){var b=a,c=function(){for(var a,c=!1,d=[],e=0,g=arguments.length;g>e;e++){var h=arguments[e];!c&&f.tools.isOptionParam(h)?(a=h,c=!0):d.push(h)}var i=a||{};return void 0===i.onSuccess&&void 0===i.onError&&void 0===i.generateRESTRequestOnly&&(i.sync=!0),f.DataStore.funcCaller(b,this,d,i)};return c},f.DataStore.getCatalog=function(a,b){var c=this,d=this.owner,e=f.tools.handleArgs(arguments,0);b=e.userData,a=e.options;var g=a.mergeCatalog||!1,h=!1,i="$all";if(null!=a.catalog&&(i="string"==typeof a.catalog?a.catalog:a.catalog.join(","),g&&(classList=i.split(","),newlist=[],classList.forEach(function(a){""!=a&&null==d[a]&&newlist.push(a)}),0==newlist.length&&(h=!0))),h){var j={dataStore:d,result:d};f.callHandler(!1,null,j,a,b)}else{i="$catalog/"+i;var k=new f.core.restConnect.restRequest(!0);k.resource=i,k.handler=function(){if(4==k.http_request.readyState){var e=!1,g=null,h=null;try{var i=f.getRequestResult(k);i&&i.dataClasses?g=i.dataClasses:i&&i.className&&(g=[i]),null==g&&(g=[]),null!=i.__ERROR&&(e=!0,h=i.__ERROR)}catch(j){g=[],e=!0,h=j}for(var l=0,m=g.length;m>l;l++){var n=g[l],o=n.name;if(null==d[o]){var p=n.collectionName,q=new f.DataClass(n,d);c.dataClasses[o]=q,null!=p&&(c.dataClassesByCollectionName[p]=q),d[o]=q}}c.ready=!0;var r={dataStore:d,result:d};r.XHR=k.http_request,f.callHandler(e,h,r,a,b)}};{k.go()}}},f.DataClass=function(a,b){var c=this,d="";a.key&&(d=a.key[0].name),c._private={primaryKey:d,className:a.name,collectionName:a.collectionName,attributesByName:{},entityMethods:{},entityCollectionMethods:{},entityMethodRefs:{},entityCollectionMethodRefs:{},dataClassMethodRefs:{},owner:c,dataStore:b,cache:new f.EntityCache,defaultTopSize:a.defaultTopSize,getEntityByURIOrKey:f.DataClass.getEntityByURIOrKey};var e=c._private,g=e.attributesByName,h=e.dataClassMethodRefs,i=e.entityCollectionMethodRefs,j=e.entityMethodRefs,k=e.entityCollectionMethods,l=e.entityMethods,m=a.attributes,n=a.methods;if(e.methods=n,null!=m)for(var o=0,p=m.length;p>o;o++){var q=m[o];q.owner=c,g[q.name]=q,"storage"==q.kind||"calculated"==q.kind||"alias"==q.kind||"composition"==q.kind?(q.simple=!0,q.related=!1,("image"==q.type||"blob"==q.type)&&(q.simple=!1)):(q.simple=!1,q.related=!0,q.resolved=!1,q.relatedOne="relatedEntity"==q.kind,q.resolve=f.DataStore.resolveRelatedAttribute,q.getRelatedClass=f.DataStore.getRelatedClassAttribute,q.relatedClass=null),c[q.name]=q}e.attributes=m;var r=n;if(null!=r)for(var o=0,s=r.length;s>o;o++){var t=r[o];"entity"==t.applyTo?(j[t.name]=t,l[t.name]=f.DataStore.makeFuncCaller(t)):"entityCollection"==t.applyTo?(i[t.name]=t,k[t.name]=f.DataStore.makeFuncCaller(t)):(h[t.name]=t,c[t.name]=f.DataStore.makeFuncCaller(t))}return this},f.DataClass.getEntityByURIOrKey=function(a,b,c,d){var e=f.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var g=this,h=g.owner,i=new f.core.restConnect.restRequest(!0);null!=b?i.fullURL=b:i.resource=h.getName()+"("+a+")",i.autoExpand=c.autoExpand,i.autoSubExpand=c.autoSubExpand,i.filterAttributes=c.filterAttributes,i.handler=function(){if(4==i.http_request.readyState){var a=!1,b=null,e=f.getRequestResult(i);null!=e.__ERROR&&(a=!0,b=e.__ERROR);var g=null;if(!a){g=new f.Entity(h,e);var j=g.getKey(),k=h.getCache(),l=k.getCacheInfo(j);if(null==l){var m=new Date;k.setEntry(j,e,m)}else k.replaceCachedEntity(j,e)}var n={entity:g,result:g};n.XHR=i.http_request,f.callHandler(a,b,n,c,d)}};i.go()},f.DataClass.getName=function(){return this._private.className},f.DataClass.getCollectionName=function(){return this._private.collectionName},f.DataClass.getDefaultTopSize=function(){return this._private.defaultTopSize},f.DataClass.getDataStore=function(){return this._private.dataStore},f.DataClass.getCache=function(){return this._private.cache},f.DataClass.setCacheSize=function(a){var b=this._private.cache;b.setSize(a)},f.DataClass.getCacheSize=function(){var a=this._private.cache;return a.maxEntities},f.DataClass.clearCache=function(){var a=this._private.cache;a.clear()},f.DataClass.getAttributeByName=function(a){var b=this;return b._private.attributesByName[a]},f.DataClass.getAttributes=function(){var a=this;return a._private.attributes},f.DataClass.getMethodList=function(){var a=this;return a._private.methods},f.DataClass.newEntity=function(){var a=new f.Entity(this);return a},f.DataClass.getEntity=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e,g=this,h=g.getCache();if(e=b.forceReload?null:h.getCacheInfo(a),null==e||null==e.rawEntity)g._private.getEntityByURIOrKey(a,null,b,c);else{var i=new f.Entity(g,e.rawEntity),j={entity:i,result:i},k=f.callHandler(!1,null,j,b,c);"boolean"==typeof k&&(k||null!=b&&(b.mustStopLoop=!0))}},f.DataClass.newCollection=function(a,b,c){if(null==a){var d=new f.EntityCollection(this,null,{createEmptyCollection:!0});return d}var e=f.tools.handleArgs(arguments,1);c=e.userData,b=e.options,b.dataURI=a.dataURI,b.pageSize=b.pageSize||a.pageSize,b.autoExpand=b.autoExpand||a.autoExpand,b.filterAttributes=b.filterAttributes||a.filterAttributes,b.savedQuery=a.savedQuery||null,b.savedOrderby=a.savedOrderby||null;var d=new f.EntityCollection(this,null,b,c);return d},f.DataClass.getEntityByURI=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;e._private.getEntityByURIOrKey(null,a,b,c)},f.DataClass.distinctValues=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=b.queryString,g=b.skip,h=b.top,i=this,j=new f.core.restConnect.restRequest(!0);j.resource=i.getName(),j.filter=e,j.skip=g,j.top=h,j.options={objectRef:this,first:g,top:h},null!=a&&(j.attributesRequested=[a]),j.distinct=!0,j.addToSet=b.addToSet,j.handler=function(){if(4==j.http_request.readyState){var a=f.getRequestResult(j),d=!1,e=null;if(null!=a.__ERROR){e=a.__ERROR,d=!0;for(var g=0;g<a.__ERROR.length;g++){var h=a.__ERROR[g];null==h.options&&(h.options={}),h.options.position=first}}var i={result:a,distinctValues:a,XHR:j.http_request};f.callHandler(d,e,i,b,c)}},j.go()},f.DataClass.query=function(a,b,c){var d=f.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,g=new f.EntityCollection(e,a,b,c);return g},f.DataClass.allEntities=function(a,b){var c=f.tools.handleArgs(arguments,0);return b=c.userData,a=c.options,this.query("",a,b)},f.DataClass.find=function(a,b,c){var d=f.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,g=(this._private,new f.core.restConnect.restRequest(!0));g.resource=e.getName(),g.autoExpand=b.autoExpand,g.filterAttributes=b.filterAttributes,g.filter=a,g.top=1,g.orderby=b.orderby,g.params=b.params,g.handler=function(){if(4==g.http_request.readyState){var a=!1,d=null,h=f.getRequestResult(g);null!=h.__ERROR&&(a=!0,d=h.__ERROR);var i=null;!a&&null!=h.__ENTITIES&&h.__ENTITIES.length>0&&(i=new f.Entity(e,h.__ENTITIES[0]));var j={entity:i,result:i,XHR:g.http_request};f.callHandler(a,d,j,b,c)}};g.go()},f.DataClass.toArray=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=new f.core.restConnect.restRequest(!0);g.resource=this.getName(),g.top=b.top||null,g.skip=b.skip||null,g.addToSet=b.addToSet,g.retainPositions=b.retainPositions||null,g.progressInfo=b.progressInfo,g.orderby=b.orderby,g.autoExpand=a,g.asArray=!0,b.filterQuery&&(g.filter=b.filterQuery,g.params=b.params),g.handler=function(){if(4==g.http_request.readyState){var a=f.getRequestResult(g),d={dataClass:e,result:a,XHR:g.http_request},h=null!=a.__ERROR;f.callHandler(h,a.__ERROR,d,b,c)}};g.go()},f.EntityCollectionPage=function(a,b){this.start=a,this.length=b,this.entityKeys=[]},f.EntityCollection=function(a,b,c,d){("''"==b||""==b)&&(b=null);var e=f.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var g,h=c.filterSet;null!=h?(g=h._private.savedQuery,null!=g?null!=b&&(g="("+g+") and "+b):saveQuery=b):g=b,null==g&&(g=c.savedQuery||null),null==c.orderby&&null!=c.orderBy&&(c.orderby=c.orderBy);var i=c.orderby||null;null==i&&(i=c.savedOrderby||null);var j=c.pageSize||40,k=this;this._private={ready:!1,owner:this,queryString:b,savedQuery:g,orderby:i,savedOrderby:i,dataURI:c.dataURI,pageSize:j,withQueryPlan:c.queryPlan,withQueryPath:c.queryPath,progressInfo:c.progressInfo,params:c.params,dataClass:a,methodRefs:a._private.entityCollectionMethodRefs,methods:a._private.entityCollectionMethods,autoExpand:c.autoExpand,autoSubExpand:c.autoSubExpand,filterAttributes:c.filterAttributes,isMethodResult:c.isMethodResult,isARelatedEntityCollection:c.isARelatedEntityCollection,loadedElemsLength:0,addedElems:[],curPendingStamp:0,pendingRequests:{},pages:[],clearCache:f.EntityCollection.clearCache,insertPage:f.EntityCollection.insertPage,findPage:f.EntityCollection.findPage,invalidPage:f.EntityCollection.invalidPage,getKeyByPos:f.EntityCollection.getKeyByPos,manageData:f.EntityCollection.manageData,fetchData:f.EntityCollection.fetchData,addPendingRequest:f.EntityCollection.addPendingRequest,clearPendingRequest:f.EntityCollection.clearPendingRequest,clearAllPendingRequest:f.EntityCollection.clearAllPendingRequest,isPagePending:f.EntityCollection.isPagePending,gotEntity:f.EntityCollection.gotEntity,updateOptions:f.EntityCollection.updateOptions};var l=this._private,m=l.methods;for(var n in m)k[n]=m[n];return this.length=0,c.init=!0,c.createEmptyCollection?(l.ready=!0,b="*"):null!=c.dataURI&&"*"==c.dataURI?l.ready=!0:null!=c.prefetchedData?k._private.manageData(c.prefetchedData,!0):(null==b&&null==l.savedQuery&&(l.savedQuery="$all"),k._private.fetchData(0,j,c,d)),k},f.EntityCollection.clearCache=function(){var a=this;a.pages=[]},f.EntityCollection.insertPage=function(a){var b=this,c=b.pages,d=c.length;if(0==d)c.push(a);else{for(var e=-1,f=0;d>f;f++){var g=c[f];if(g.start>a.start){e=f;break}}-1==e?c.push(a):c.splice(e,0,a)}},f.EntityCollection.findPage=function(a){for(var b=this,c=b.pages,d=c.length,e=0,f=d;f>e;){var g=Math.floor((f-e)/2)+e,h=c[g];if(h.start<=a&&h.start+h.length>a)return g;a<h.start?f=g:e=g+1}return-1},f.EntityCollection.invalidPage=function(a){var b=this,c=b.findPage(a);-1!=c&&b.pages.splice(c,1)},f.EntityCollection.getKeyByPos=function(a){var b=null,c=this,d=c.findPage(a);if(-1!=d){var e=c.pages[d],f=e.entityKeys[a-e.start];b=f.key}return b},f.EntityCollection.addPendingRequest=function(a,b){var c=this;return c.curPendingStamp++,c.pendingRequests[c.curPendingStamp]={start:a,length:b},c.curPendingStamp},f.EntityCollection.clearPendingRequest=function(a){var b=this;delete b.pendingRequests[a]},f.EntityCollection.clearAllPendingRequest=function(){var a=this;for(var b in a.pendingRequests)a.pendingRequests[b]},f.EntityCollection.isPagePending=function(a){var b=this;for(var c in b.pendingRequests){var d=b.pendingRequests[c];if(d.start<=a&&d.start+d.length>a)return!0}return!1},f.EntityCollection.manageData=function(a,b){var c=this,d=this.owner,e=d.getDataClass(),g=e.getCache();b=b||!1,b&&(d.length=a.__COUNT,c.ready=!0,c.loadedElemsLength=d.length,c.dataURI=a.__ENTITYSET,null!=c.autoSubExpand&&(c.autoExpand=c.autoSubExpand,c.autoSubExpand=null));var h=a.__SENT,i=a.__FIRST;g.makeRoomFor(h);for(var j=a.__ENTITIES,k=new Date,l=new f.EntityCollectionPage(i,h),m=0;h>m;m++){var n,o=j[m];if(null==o)g.setEntry("",{__STAMP:0},k),n="";else{n=o.__KEY,null==n&&(n="");var p=g.setEntry(n,o,k)}l.entityKeys.push({key:o.__KEY,stamp:p})}c.insertPage(l)},f.EntityCollection.fetchData=function(a,b,c,d){var e=f.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var g=c.filterSet,h=c.init||!1,i=this,j=this.owner,k=j.getDataClass(),l=(k.getCache(),i.addPendingRequest(a,b)),m=new f.core.restConnect.restRequest(!0);if(m.entityCollection=j,m.resource=i.dataClass.getName(),null!=g?null!=g._private.dataURI?(m.dataURI=g._private.dataURI,m.filter=i.queryString):m.filter=i.savedQuery:m.filter=i.queryString,m.top=b,m.skip=a,m.attributesRequested=null,m.attributesExpanded=null,m.autoExpand=i.autoExpand,m.autoSubExpand=i.autoSubExpand,m.filterAttributes=i.filterAttributes,m.params=i.params,i.mustRefreshCollectionOnNextFetch&&(m.refreshOnly=!0,i.mustRefreshCollectionOnNextFetch=!1),c.fromSelection&&(m.fromSelection=c.fromSelection),h){m.removeAtPos=c.removeAtPos,m.removeReferenceOnly=c.removeReferenceOnly,m.addToSet=c.addToSet;var n=m.fromSelection;null!=n&&(m.fromSelection=n.prepareToSend())}m.queryPlan=i.withQueryPlan,m.progressInfo=i.progressInfo,m.method=i.isARelatedEntityCollection?"subentityset":"entityset",m.timeout=c.timeout||300,m.savedOrderby=i.savedOrderby,m.savedQueryString=i.savedQuery,m.dataURI=m.dataURI||i.dataURI,m.dataURI&&null==g&&(m.filter=null),m.orderby=c.orderby,m.subOrderby=c.subOrderby,m.keepSelection=c.keepSelection,m.handler=function(){if(4==m.http_request.readyState){i.clearPendingRequest(l);var a=f.getRequestResult(m),b={entityCollection:j,result:j,XHR:m.http_request},e=null!=a.__ERROR;e||(null!=a.__transformedSelection&&(b.transformedSelection=a.__transformedSelection),i.manageData(a,h)),f.callHandler(e,a.__ERROR,b,c,d)}};m.go()},f.EntityCollection.updateOptions=function(a){var b=this;if(b.addedElems.length>0){for(var c=[],d=0,e=b.addedElems.length;e>d;d++){var f=b.addedElems[d],g=null;null!=f&&f.getKey&&(g=f.getKey()),null!=g&&c.push(g)}c.length>0&&(a.addToSet=c)}},f.EntityCollection.getDataClass=function(){var a=this;return a._private.dataClass},f.EntityCollection.getReference=function(){var a=null,b=this,c=b._private;return null!=c.dataURI&&(a={dataURI:c.dataURI},null!=c.savedQuery&&(a.savedQuery=c.savedQuery),null!=c.savedOrderby&&(a.savedOrderby=c.savedOrderby),null!=c.pageSize&&(a.pageSize=c.pageSize),null!=c.autoExpand&&(a.autoExpand=c.autoExpand)),a},f.EntityCollection.query=function(a,b,c){var d=f.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this;b.filterSet=e;var g=e.getDataClass();b.pageSize=b.pageSize||e._private.pageSize,b.autoExpand=b.autoExpand||e._private.autoExpand,b.filterAttributes=b.filterAttributes||e._private.filterAttributes,e._private.updateOptions(b);var h=new f.EntityCollection(g,a,b,c);return h},f.EntityCollection.orderBy=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;if(0==this.length){var g={entityCollection:e,result:e};return f.callHandler(!1,null,g,b,c),e}b.orderby=a;var h=e._private;b.dataURI=h.dataURI;var i=e.getDataClass();b.pageSize=b.pageSize||h.pageSize,b.autoExpand=b.autoExpand||h.autoExpand,b.filterAttributes=b.filterAttributes||h.filterAttributes,h.updateOptions(b),b.savedQuery=h.savedQuery||null;var j=new f.EntityCollection(i,null,b,c);return j},f.EntityCollection.getEntities=function(a,b,c,d){var e=f.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var g=this,h=g._private,i=h.loadedElemsLength,j=h.addedElems.length,k=g.getDataClass();h.updateOptions(c);var l=[],m={entityCollection:g,result:g,position:a,howMany:b,entities:l};if(a>=i){var n=a-i,o=b;if(o>j-n&&(o=j-n),j>n)for(var p=n;n+o>p;++p)l.push(h.addedElems[p]);f.callHandler(!1,null,m,c,d)}else{var o=b;a+o>i+j&&(o=i+j-a);var q=o;a+q>i&&(q=i-a),h.fetchData(a,q,{onSuccess:function(){cache=k.getCache();for(var b=a;a+q>b;++b){var e=h.getKeyByPos(b),g=cache.getCacheInfo(e);if(null!=g){var i=new f.Entity(k,g.rawEntity);l.push(i)}else l.push(null)}if(o>q)for(var j=o-q,b=0;j>b;++b)l.push(h.addedElems[b]);f.callHandler(!1,null,m,c,d)},onError:function(a){f.callHandler(!0,a.error,m,c,d)},addToSet:c.addToSet||null})}},f.EntityCollection.getEntity=function(a,b,c,d){var e=!1,g=f.tools.handleArgs(arguments,1);c=g.userData,b=g.options;var h=null!=b&&(b.forceCollectionRefresh||!1);d=g.nextParam<arguments.length?arguments[g.nextParam]||!1:!1;var i=this,j=i._private,k=j.loadedElemsLength;h&&(j.clearAllPendingRequest(),j.clearCache(),j.mustRefreshCollectionOnNextFetch=!0,k=i.length);var l=i.getDataClass();if(a>=k){var m={entityCollection:i,result:i,position:a},n=a-j.loadedElemsLength;n<j.addedElems.length?(m.entity=j.addedElems[n],f.callHandler(!1,null,m,b,c)):h?f.callHandler(!1,null,m,b,c):f.callHandler(!0,[{error:501,message:"wrong position in entityCollection"}],m,b,c)}else{var o=!1,p=j.getKeyByPos(a);if(null!=p||d||(j.isPagePending(a)?setTimeout(function(){i.getEntity(a,b,c)},100):o=!0),null!=p){var q=l.getCache(),r=q.getCacheInfo(p);null!=r?(e=!0,j.gotEntity(r,b,c,a)):(o=!0,p=null,j.invalidPage(a))}if(d&&(o=!1),null==p&&o){var s,t;if(null!=b?(s=b.delay,t=b.delayInfo):(s=null,t=null),null!=s&&0!=s&&null!=t){var u=t.findMatchingPendingRequest(a);if(null==u){var v=a-20;0>v&&(v=0),u=t.addPendingRequest(0,v,a+j.pageSize-1),u.addFetchRequest(a,b,c);var w=setTimeout(function(){if(u.matchRange(t.top,t.bottom)){var a={};h&&j.updateOptions(a),j.fetchData(u.top,u.bottom-u.top+1,{onSuccess:function(){h&&(j.addedElems=[]),u.pendingFetch.forEach(function(a){if(a.pos>=t.top&&a.pos<=t.bottom){p=j.getKeyByPos(a.pos),q=l.getCache();var b=q.getCacheInfo(p);null!=b?j.gotEntity(b,a.options,a.userData,a.pos):j.gotEntity(null,a.options,a.userData)
}}),t.removePendingRequest(u)},onError:function(a){u.pendingFetch.forEach(function(b){if(b.pos>=t.top&&b.pos<=t.bottom){var c={entityCollection:i,result:i,position:b.pos,entity:null};f.callHandler(!0,a.error,c,b.options,b.userData)}}),t.removePendingRequest(u)},init:h,addToSet:a.addToSet||null})}else t.removePendingRequest(u)},s);u.setRequestID(w)}else u.addFetchRequest(a,b,c)}else{var x={};h&&j.updateOptions(x),j.fetchData(a,j.pageSize,{onSuccess:function(){h&&(j.addedElems=[]),p=j.getKeyByPos(a),q=l.getCache();var d=q.getCacheInfo(p);null!=d?j.gotEntity(d,b,c,a):j.gotEntity(null,b,c)},onError:function(d){var e={entityCollection:i,result:i,position:a,entity:null};f.callHandler(!0,d.error,e,b,c)},init:h,addToSet:x.addToSet||null})}}}return e},f.EntityCollection.gotEntity=function(a,b,c,d){var e,g=this,h=g.owner;e=null!=a?new f.Entity(h.getDataClass(),a.rawEntity):null;var i={entityCollection:h,result:e,entity:e,position:d};f.callHandler(!1,null,i,b,c)},f.EntityCollection.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,g=arguments.length;g>e;e++)d.push(arguments[e]);return f.DataStore.funcCaller(c,b,d,a)}},f.EntityCollection.parseForEach=function(a,b){for(var c=!0,d=b.entityCollection,e=(d._private,!1);c&&b.curelem<b.limit&&!e;)c=d.getEntity(b.curelem,a,b.userData,!0),null!=a&&a.mustStopLoop?e=!0:c?b.curelem++:d.getEntity(b.curelem,{onSuccess:function(){f.EntityCollection.parseForEach(a,b)},onError:function(c){f.callHandler(!0,c.error,c,a,b.userData)}},b);if(c&&null!=a.atTheEnd){var g={entityCollection:d,userData:b.userData};a.atTheEnd(g)}return c},f.EntityCollection.forEach=function(a,b){var c=this,d=(c._private,f.tools.handleArgs(arguments,0,{with3funcs:!0}));b=d.userData,a=d.options;var e={curelem:a.first||0,limit:a.limit||c.length,userData:b,entityCollection:c};f.EntityCollection.parseForEach(a,e)},f.EntityCollection.add=function(a){null!=a&&(this._private.addedElems.push(a),this.length++)},f.EntityCollection.refresh=function(a,b){a=a||{},a.forceCollectionRefresh=!0;var c=0;null!=a.refreshCollectionFrom&&(c=a.refreshCollectionFrom),b=b,this.getEntity(c,a,b)},f.EntityCollection.toArray=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=e._private;g.updateOptions(b);var h=new f.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=g.dataClass.getName(),h.top=b.top||g.pageSize||40,h.skip=b.skip||null,h.params=g.params,h.addToSet=b.addToSet,h.retainPositions=b.retainPositions||null,h.progressInfo=b.progressInfo||g.progressInfo,h.savedOrderby=g.savedOrderby,h.savedQueryString=g.savedQuery,h.dataURI=g.dataURI,h.orderby=b.orderby,h.autoExpand=a,h.asArray=!0,b.filterQuery&&(h.filter=b.filterQuery,h.params=b.params),h.handler=function(){if(4==h.http_request.readyState){var a=f.getRequestResult(h),d={entityCollection:e,result:a,XHR:h.http_request},g=null!=a.__ERROR;f.callHandler(g,a.__ERROR,d,b,c)}};h.go()},f.EntityCollection.distinctValues=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=e._private;g.updateOptions(b);var h=new f.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=g.dataClass.getName(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=g.params,h.progressInfo=b.progressInfo||g.progressInfo,h.savedOrderby=g.savedOrderby,h.savedQueryString=g.savedQuery,h.dataURI=g.dataURI,h.distinct=!0,null!=a&&(h.attributesRequested=[a]),h.handler=function(){if(4==h.http_request.readyState){var a=f.getRequestResult(h),d={entityCollection:e,distinctValues:a,result:a,XHR:h.http_request},g=null!=a.__ERROR;f.callHandler(g,a.__ERROR,d,b,c)}};h.go()},f.EntityCollection.findKey=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=e._private;g.updateOptions(b);var h=new f.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=g.dataClass.getName(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=g.params,h.progressInfo=b.progressInfo||g.progressInfo,h.savedOrderby=g.savedOrderby,h.savedQueryString=g.savedQuery,h.dataURI=g.dataURI,a instanceof Date&&(a=a.toISO()),h.findKey=a,h.handler=function(){if(4==h.http_request.readyState){var a=f.getRequestResult(h),d={entityCollection:e,result:a.result,XHR:h.http_request},g=null!=a.__ERROR;f.callHandler(g,a.__ERROR,d,b,c)}};h.go()},f.EntityCollection.removeEntityReference=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options,b.removeReferenceOnly=!0,this.removeEntity(a,b,c)},f.EntityCollection.removeEntity=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=e._private;b.dataURI=g.dataURI;var h=e.getDataClass();if(!(a>=g.loadedElemsLength&&a<e.length)){b.pageSize=b.pageSize||g.pageSize,b.autoExpand=b.autoExpand||g.autoExpand,b.filterAttributes=b.filterAttributes||g.filterAttributes,g.updateOptions(b),b.removeAtPos=a,b.savedQuery=g.savedQuery||null,b.savedOrderby=g.savedOrderby||null;var i=new f.EntityCollection(h,null,b,c);return i}var j=a-g.loadedElemsLength,k=g.addedElems[j],l={entityCollection:e,result:e};null==k||null==k.getKey()||b.removeReferenceOnly?(g.addedElems.splice(j,1),e.length--,f.callHandler(!1,null,l,b,c)):k.remove({onSuccess:function(){g.addedElems.splice(j,1),e.length--,f.callHandler(!1,null,l,b,c)},onError:function(a){f.callHandler(!0,a.error,l,b,c)}})},f.EntityCollection.removeAllEntities=function(a,b){var c=f.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e=d._private;e.updateOptions(a);var g=new f.core.restConnect.restRequest(!0);g.entityCollection=d,g.resource=e.dataClass.getName(),g.addToSet=a.addToSet,g.params=e.params,g.progressInfo=a.progressInfo||e.progressInfo,g.savedOrderby=e.savedOrderby,g.savedQueryString=e.savedQuery,g.dataURI=e.dataURI,g.method="delete",g.atOnce=a.atOnce,g.handler=function(){if(4==g.http_request.readyState){var c=f.getRequestResult(g),e={entityCollection:d,XHR:g.http_request},h=null!=c.__ERROR;f.callHandler(h,c.__ERROR,e,a,b)}};g.go()},f.EntityCollection.buildFromSelection=function(a,b,c){var d=f.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,g=e._private,h=e.getDataClass();b.pageSize=b.pageSize||g.pageSize,b.autoExpand=b.autoExpand||g.autoExpand,b.filterAttributes=b.filterAttributes||g.filterAttributes,g.updateOptions(b),b.filterSet=e,b.fromSelection=a,b.savedQuery=g.savedQuery||null,b.savedOrderby=g.savedOrderby||null;var i=new f.EntityCollection(h,null,b,c);return i},f.EntityAttributeSimple=function(a,b,e){this.owner=a,this.value="date"==e.type&&"string"==typeof b?e.simpleDate?d(b):c(b):b,this.touched=!1,this.att=e,this.getValue=f.EntityAttributeSimple.getValue,this.setValue=f.EntityAttributeSimple.setValue,this.touch=f.EntityAttributeSimple.touch,this.isTouched=f.EntityAttributeSimple.isTouched,this.clearTouched=f.EntityAttributeSimple.clearTouched,this.getOldValue=f.EntityAttributeSimple.getOldValue,this.setRawValue=f.EntityAttributeSimple.setRawValue,this.getRawValue=f.EntityAttributeSimple.getRawValue},f.EntityAttributeSimple.getValue=function(){return this.value},f.EntityAttributeSimple.setValue=function(a){void 0===this.oldValue&&(this.oldValue=this.value),this.value=a,this.touch()},f.EntityAttributeSimple.touch=function(){this.touched=!0,this.owner.touch()},f.EntityAttributeSimple.clearTouched=function(){this.touched=!1},f.EntityAttributeSimple.isTouched=function(){return this.touched},f.EntityAttributeSimple.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},f.EntityAttributeSimple.setRawValue=function(a){this.value="date"===this.att.type&&"string"==typeof a?this.att.simpleDate?d(a):c(a):a,delete this.oldValue},f.EntityAttributeSimple.getRawValue=function(){var a=this.value;return null!=a&&"date"==this.att.type&&(a=this.att.simpleDate?a.toSimpleDateString():a.toISO()),a},f.EntityAttributeRelated=function(a,b,c){if(f.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntity=null,this.dataURI=b.__deferred.uri,this.relKey=b.__deferred.__KEY;else{var d=c.getRelatedClass();null==d?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new f.Entity(d,b),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;this.setValue=f.EntityAttributeRelated.setValue,this.getValue=f.EntityAttributeRelated.getValue,this.load=this.getValue,this.setRawValue=f.EntityAttributeRelated.setRawValue,this.getRawValue=f.EntityAttributeRelated.getRawValue,this.getOldValue=f.EntityAttributeRelated.getOldValue},f.EntityAttributeRelated.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},f.EntityAttributeRelated.getValue=function(a,b){if(null==a)return this.relEntity;var c=f.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e={entity:null};if(null==d.relEntity)if(null==d.dataURI&&null==d.relKey)f.callHandler(!1,null,e,a,b);else{var g=d.att.getRelatedClass();null==g?f.callHandler(!1,null,e,a,b):null!=d.relKey?g.getEntity(d.relKey,{onSuccess:function(c){d.relEntity=c.entity,f.callHandler(!1,null,c,a,b)},onError:function(c){f.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand}):g.getEntityByURI(d.dataURI,{onSuccess:function(c){d.relEntity=c.entity,f.callHandler(!1,null,c,a,b)},onError:function(c){f.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand})}else e.entity=d.relEntity,f.callHandler(!1,null,e,a,b)},f.EntityAttributeRelated.setValue=function(a){void 0===this.oldValue&&(this.oldValue=this.relEntity),this.relEntity=a,this.touched=!0,this.owner.touch(),this.dataURI=null,this.relKey=null==a?null:a.getKey()},f.EntityAttributeRelated.setRawValue=function(a){if(null!=a)if(null!=a.__deferred)this.relEntity=null,this.dataURI=a.__deferred.uri,this.relKey=a.__deferred.__KEY;else{var b=this.att.getRelatedClass();null==b?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new f.Entity(b,a),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;delete this.oldValue},f.EntityAttributeRelated.getRawValue=function(){var a=this.relEntity;if(null!=a){var b=a.getKey();a=null!=b?{__KEY:b}:a._private.getRESTFormat()}return a},f.EntityAttributeRelatedSet=function(a,b,c){if(f.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntityCollection=null,this.dataURI=b.__deferred.uri;else{var d=c.getRelatedClass();null==d?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new f.EntityCollection(d,null,{prefetchedData:b}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null;this.setValue=f.EntityAttributeRelatedSet.setValue,this.getValue=f.EntityAttributeRelatedSet.getValue,this.setRawValue=f.EntityAttributeRelatedSet.setRawValue},f.EntityAttributeRelatedSet.setRawValue=function(a){if(null!=a)if(null!=this.dataURI&&a.__deferred==this.dataURI);else if(null!=a.__deferred)this.relEntityCollection=null,this.dataURI=a.__deferred.uri;else{var b=this.att.getRelatedClass();null==b?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new f.EntityCollection(b,null,{prefetchedData:a}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null},f.EntityAttributeRelatedSet.getValue=function(a,b){if(null==a)return this.relEntityCollection;var c=f.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=null,e={entityCollection:null};if(null!=this.relEntityCollection)if(d=this.relEntityCollection,d._private.ready)e.entityCollection=d,f.callHandler(!1,null,e,a,b);else{var g=function(){d._private.ready?(e.entityCollection=d,f.callHandler(!1,null,e,a,b)):setTimeout(g,100)};setTimeout(g,100)}else{var h=this.att.getRelatedClass();null==h?f.callHandler(!0,{error:601,errorMessage:"wrong entityCollection reference"},e,a,b):(null==this.dataURI&&(this.dataURI="*"),a.isARelatedEntityCollection=!0,a.dataURI=this.dataURI,this.relEntityCollection=new f.EntityCollection(h,null,a,b),d=this.relEntityCollection)}return d},f.Entity=function(a,b,c){var d=this;this._private={touched:!1,isNew:!0,dataClass:a,owner:this,values:{},methodRefs:a._private.entityMethodRefs,methods:a._private.entityMethods,getRESTFormat:f.Entity.getRESTFormat};var e=this._private,g=e.methods;for(var h in g)d[h]=g[h];this.touch=f.Entity.touch,this.getDataClass=f.Entity.getDataClass,this.getKey=f.Entity.getKey,this.setStamp=f.Entity.setStamp,this.setKey=f.Entity.setKey,this.getStamp=f.Entity.getStamp,this.callMethod=f.Entity.callMethod,this.isNew=f.Entity.isNew,this.isTouched=f.Entity.isTouched,this.save=f.Entity.save,this.remove=f.Entity.remove,this.serverRefresh=f.Entity.serverRefresh;var i=!1;null==b||null==b.__KEY?(this._private.key=null,this._private.stamp=0,this._private.isNew=!0,i=!0,null!=b&&(this._private.touched=!0)):(this._private.key=b.__KEY,this._private.stamp=b.__STAMP,this._private.isNew=!1);var j=d._private.values;c=c||{};var k=a._private.attributesByName;for(var h in k){var l,m=k[h],n=null==b?null:null==b[h]?null:b[h];l=m.related?m.relatedOne?new f.EntityAttributeRelated(d,n,m):new f.EntityAttributeRelatedSet(d,n,m):new f.EntityAttributeSimple(d,n,m),i&&null!=n&&(l.touched=!0),j[h]=l,d[h]=l}},f.Entity.getRESTFormat=function(a){var b=this,c=this.owner,d={},e=c.getKey();null!=e?(d.__KEY=e,d.__STAMP=c.getStamp(),a&&(d.__STAMP=-d.__STAMP)):d.__ISNEW=!0;for(var f in b.values){var g=b.values[f];g.isTouched()&&(d[f]=g.getRawValue())}return d},f.Entity.touch=function(){this._private.touched=!0},f.Entity.getDataClass=function(){return this._private.dataClass},f.Entity.getKey=function(){return this._private.key},f.Entity.getStamp=function(){return this._private.stamp},f.Entity.setKey=function(a){this._private.key=a},f.Entity.setStamp=function(a){this._private.stamp=a},f.Entity.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,g=arguments.length;g>e;e++)d.push(arguments[e]);return f.DataStore.funcCaller(c,b,d,a)}},f.Entity.isNew=function(){return this._private.isNew},f.Entity.isTouched=function(){return this._private.touched},f.Entity.serverRefresh=function(a,b){var c=f.tools.handleArgs(arguments,0);b=c.userData,a=c.options,a.refreshOnly=!0,this.save(a,b)},f.Entity.remove=function(a,b){var c=this,d=f.tools.handleArgs(arguments,0);b=d.userData,a=d.options;var e=c.getDataClass(),g=e.getName(),h=c.getKey(),i=new f.core.restConnect.restRequest(!0);i.resource=g+"("+h+")",i.method="delete",i.handler=function(){if(4==i.http_request.readyState){var d=!1,g=null,j=f.getRequestResult(i);null!=j.__ERROR?(d=!0,g=j.__ERROR):e.getCache().removeCachedEntity(h);var k={entity:c};f.callHandler(d,g,k,a,b)}};i.go()},f.Entity.save=function(a,b){var c=this,d=f.tools.handleArgs(arguments,0);b=d.userData,a=d.options;var e=c.getDataClass(),g=e.getName(),h=a.refreshOnly;null==h&&(h=!1);var i=new f.core.restConnect.restRequest(!0);i.resource=g;var j=c.getKey();null==j?(i.method="update",i.httpMethod=f.core.restConnect.httpMethods._post):(i.method="update",i.httpMethod=f.core.restConnect.httpMethods._post),i.postdata='{ "__ENTITIES": ['+JSON.stringify(c._private.getRESTFormat(a.overrideStamp))+"]}",i.refreshOnly=h,null!=a.autoExpand&&(i.autoExpand=a.autoExpand),null!=a.filterAttributes&&(i.filterAttributes=a.filterAttributes),i.handler=function(){if(4==i.http_request.readyState){var d=f.getRequestResult(i),g={entity:c,rawResult:d,XHR:i.http_request},d=JSON.parse(i.http_request.responseText),j=!1,k=null;if(d&&d.__ENTITIES&&d.__ENTITIES[0]){var l=d.__ENTITIES[0];if(l.__ERROR)k=l.__ERROR,j=!0;else{var m=l.__KEY;h||(null!=m&&(c._private.key=m),c._private.stamp=l.__STAMP);var n=e._private.attributesByName;for(var o in n){var p=n[o],q=l[o];void 0===q&&(q=null);var r=c[o];null==r?(r=p.related?p.relatedOne?new f.EntityAttributeRelated(c,q,p):new f.EntityAttributeRelatedSet(c,q,p):new f.EntityAttributeSimple(c,q,p),c[o]=r):(r.setRawValue(q),h||r.clearTouched())}e.getCache().replaceCachedEntity(m,l),h||(c._private.touched=!1,c._private.isNew=!1)}}f.callHandler(j,k,g,a,b)}};i.go()},f.EntityCollection.prototype.getDataClass=f.EntityCollection.getDataClass,f.EntityCollection.prototype.query=f.EntityCollection.query,f.EntityCollection.prototype.getEntity=f.EntityCollection.getEntity,f.EntityCollection.prototype.getEntities=f.EntityCollection.getEntities,f.EntityCollection.prototype.callMethod=f.EntityCollection.callMethod,f.EntityCollection.prototype.each=f.EntityCollection.forEach,f.EntityCollection.prototype.forEach=f.EntityCollection.forEach,f.EntityCollection.prototype.add=f.EntityCollection.add,f.EntityCollection.prototype.orderBy=f.EntityCollection.orderBy,f.EntityCollection.prototype.toArray=f.EntityCollection.toArray,f.EntityCollection.prototype.distinctValues=f.EntityCollection.distinctValues,f.EntityCollection.prototype.findKey=f.EntityCollection.findKey,f.EntityCollection.prototype.removeEntity=f.EntityCollection.removeEntity,f.EntityCollection.prototype.removeEntityReference=f.EntityCollection.removeEntityReference,f.EntityCollection.prototype.removeAllEntities=f.EntityCollection.removeAllEntities,f.EntityCollection.prototype.buildFromSelection=f.EntityCollection.buildFromSelection,f.EntityCollection.prototype.getReference=f.EntityCollection.getReference,f.EntityCollection.prototype.refresh=f.EntityCollection.refresh,f.DataClass.prototype.distinctValues=f.DataClass.distinctValues,f.DataClass.prototype.all=f.DataClass.allEntities,f.DataClass.prototype.allEntities=f.DataClass.allEntities,f.DataClass.prototype.query=f.DataClass.query,f.DataClass.prototype.find=f.DataClass.find,f.DataClass.prototype.getAttributeByName=f.DataClass.getAttributeByName,f.DataClass.prototype.getAttributes=f.DataClass.getAttributes,f.DataClass.prototype.getMethodList=f.DataClass.getMethodList,f.DataClass.prototype.getCache=f.DataClass.getCache,f.DataClass.prototype.getCacheSize=f.DataClass.getCacheSize,f.DataClass.prototype.setCacheSize=f.DataClass.setCacheSize,f.DataClass.prototype.clearCache=f.DataClass.clearCache,f.DataClass.prototype.newEntity=f.DataClass.newEntity,f.DataClass.prototype.getEntity=f.DataClass.getEntity,f.DataClass.prototype.getEntityByURI=f.DataClass.getEntityByURI,f.DataClass.prototype.getDataStore=f.DataClass.getDataStore,f.DataClass.prototype.getCollectionName=f.DataClass.getCollectionName,f.DataClass.prototype.getDefaultTopSize=f.DataClass.getDefaultTopSize,f.DataClass.prototype.getName=f.DataClass.getName,f.DataClass.prototype.newCollection=f.DataClass.newCollection,f.DataClass.prototype.toArray=f.DataClass.toArray,f.DataClass.prototype.callMethod=f.DataStore.callMethod,f.directory=f.directory||{},f.directory.login=f.DataStore.makeFuncCaller({name:"login",applyTo:"general",nameSpace:"$directory"}),f.directory.loginByPassword=f.directory.login,f.directory.logout=f.DataStore.makeFuncCaller({name:"logout",applyTo:"general",nameSpace:"$directory"}),f.directory.loginByKey=f.DataStore.makeFuncCaller({name:"loginByKey",applyTo:"general",nameSpace:"$directory"}),f.directory.currentUser=f.DataStore.makeFuncCaller({name:"currentUser",applyTo:"general",nameSpace:"$directory"}),f.directory.currentUserBelongsTo=f.DataStore.makeFuncCaller({name:"currentUserBelongsTo",applyTo:"general",nameSpace:"$directory"}),f.dsExport=f.dsExport||{},f.dsExport.exportData=f.DataStore.makeFuncCaller({name:"exportData",applyTo:"general",nameSpace:"$impexp"});var g=angular.module("wakanda",[]);g.factory("$wakanda",["$q","$rootScope","$http",function(a,b,c){var d=null,g={},h=40,i=function(b){console.log(">$wakanda init");var c=a.defer();return("string"!=typeof b||"*"===b||""===b)&&(b=null),null===d?new f.DataStore({onSuccess:function(a){d=a.dataStore,m.wafDatastore(d),m.wafDataClasses(d),c.resolve(d)},onError:function(a){d=null,console.error(">$wakanda init > error",a),c.reject(a)},catalog:b}):c.resolve(d),c.promise},j=function(){if(null!==d)return d;throw new Error("The Datastore isn't initialized please execute .init(catalog) before you run your app.")},k=function(a){var c=b.$$phase;"$apply"===c||"$digest"===c?a&&"function"==typeof a&&a():b.$apply(a)},l={shallowClearAndCopy:function(a,b){b=b||{},angular.forEach(b,function(a,c){delete b[c]});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}},m={wafDatastore:function(a){a.$Entity=D.prototype},wafDataClasses:function(a){var b;f.DataClass.prototype.$find=A,f.DataClass.prototype.$findOne=B,f.DataClass.prototype.$create=p;for(b in a)a.hasOwnProperty(b)&&"_private"!==b&&/^\$.*/.test(b)===!1&&(m.wafDataClassAddMetas(a[b]),m.wafDataClassCreateNgWakEntityClasses(a[b]))},wafDataClassAddMetas:function(a){var b,c,d=[],e=[],f=[];for(b in a._private.dataClassMethodRefs)a._private.dataClassMethodRefs.hasOwnProperty(b)&&d.push(b);for(b in a._private.entityCollectionMethodRefs)a._private.entityCollectionMethodRefs.hasOwnProperty(b)&&e.push(b);for(b in a._private.entityMethodRefs)a._private.entityMethodRefs.hasOwnProperty(b)&&f.push(b);c=a._private.attributesByName,a.$attr=function(a){return"undefined"==typeof a?c:a&&c[a]?c[a]:null},a.$dataClassMethods=function(){return d},a.$collectionMethods=function(){return e},a.$entityMethods=function(){return f},a.$name=a._private.className,a.$collectionName=a._private.collectionName},wafDataClassCreateNgWakEntityClasses:function(a){var b;b=n.createUserDefinedEntityMethods(a),g[a._private.className]=D.extend(b),d[a._private.className].$Entity=g[a._private.className].prototype}},n={createUserDefinedEntityMethods:function(a){var b,c={};for(b in a._private.entityMethods)a._private.entityMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_entity[b].apply(this.$_entity,arguments)},n.wakandaUserDefinedMethodToPromisableMethods(c,b,a._private.entityMethods[b]));return c},createUserDefinedEntityCollectionMethods:function(a){var b,c={};for(b in a._private.entityCollectionMethods)a._private.entityCollectionMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_collection[b].apply(this.$_collection,arguments)},n.wakandaUserDefinedMethodToPromisableMethods(c,b,a._private.entityCollectionMethods[b]));return c},wakandaUserDefinedMethodToPromisableMethods:function(b,c,d){b[c]=function(){var b,c,e,g=[],h={};if(this instanceof D){if("undefined"==typeof this.$_entity||!this.$_entity instanceof f.Entity)throw new Error("Calling user defined method on unfetched entity, please call $fetch before or retrieve data on $find");c="$_entity"}else c="$_collection";if(arguments.length>0)for(var i=0;i<arguments.length;i++)g.push(arguments[i]);"$_entity"===c&&this.$syncPojoToEntity(),e=a.defer();var b=this;if(h.onSuccess=function(a){k(function(){"$_entity"===c&&b.$syncEntityToPojo(),e.resolve(a)})},h.onError=function(a){k(function(){console.error("userMethods.onError","error",a),e.reject(a)})},g.unshift(h),"$_entity"===c)d.apply(this[c],g);else{if(!this.$_collection)throw new Error("Couldn't call user defined method on collection because no pointer on this collection");d.apply(this[c],g)}return e.promise}}},o={queryEventToNgWakEntityCollection:function(a,b){var c,d,e;return d=JSON.parse(a.XHR.response),c=d.__ENTITIES,e=o.jsonResponseToNgWakEntityCollection(a.result.getDataClass(),c),b!==!0?e.$_collection=a.result:e=1===e.length?e[0]:null,a.result=e,a},jsonResponseToNgWakEntityCollection:function(a,b){var c=[];return b.map(function(b){c.push(a.$create(b))}),c},fetchEventToNgWakEntityCollection:function(a){var b=[],c=a.result._private.dataClass;a.entities.forEach(function(a){b.push(c.$create(a))}),a.result=b},asyncResult:function(a,b,c){a instanceof Array?(b.length=0,angular.forEach(a,function(a){b.push(a)}),b.$_collection=a.$_collection,o.addFrameworkMethodsToRootCollection(b),o.addUserDefinedMethodsToCollection(b,!0),b.$promise=c):(l.shallowClearAndCopy(a,b),b.$promise=c)},addUserDefinedMethodsToCollection:function(a,b){var c,d=null;if(b===!0?"undefined"!=typeof a.$_collection&&(d=a.$_collection.getDataClass()):b===!1&&"undefined"!=typeof a.$_collection&&"undefined"!==a.$_collection.relEntityCollection&&(d=a.$_collection.relEntityCollection),null===d)return a;c=n.createUserDefinedEntityCollectionMethods(d);for(var e in c)c.hasOwnProperty(e)&&(a[e]=c[e]);return a},addFrameworkMethodsToRootCollection:function(a){a.$fetch=v,a.$add=z,a.$more=w,a.$nextPage=x,a.$prevPage=y,a.$totalCount=a.$_collection.length,a.$toJSON=$$toJSON},addFrameworkMethodsToNestedCollection:function(a){a.$fetch=t,a.$more=w,a.$nextPage=x,a.$prevPage=y,a.$toJSON=$$toJSON,a.$isLoaded=$$isLoadedOnNestedCollection,a.$totalCount=null}},p=function(a){var b,c=this._private.className;return b=new g[c],q(a,b,this),b},q=function(a,b,c){var e,h,i,j=c.$attr(),k=a instanceof f.Entity,l={uri:"src"};if(null!==a&&"undefined"!=typeof a){k===!1?a.__deferred?b.$_deferred={uri:a.__deferred.uri,dataClass:c}:a.value&&a.value.__deferred?b.$_deferred={uri:a.value.__deferred.uri,dataClass:c}:b.$_entity=new f.Entity(c,a):b.$_entity=a,k?(b.__KEY=a.getKey(),b.__STAMP=a.getStamp()):("undefined"!=typeof a.__KEY&&(b.__KEY=a.__KEY),"undefined"!=typeof a.__STAMP&&(b.__STAMP=a.__STAMP));for(e in j)if("undefined"!=typeof a[e])if("storage"===j[e].kind||"calculated"===j[e].kind)if("image"===j[e].type){if(b[e]={},i=k?a[e].getValue():a[e],i&&i.__deferred)for(h in i.__deferred)b[e][l[h]?l[h]:h]=i.__deferred[h];else b[e][l.uri]=null;b[e].$upload=r}else k?b[e]=a[e].getValue():"undefined"!=typeof a[e]&&(b[e]=k?a[e].getValue():a[e]);else"relatedEntities"===j[e].kind?(a[e].__ENTITIES?(b[e]=o.jsonResponseToNgWakEntityCollection(j[e].getRelatedClass(),a[e].__ENTITIES),o.addFrameworkMethodsToNestedCollection(b[e])):a[e].__deferred&&(b[e]=[],b[e].$_deferred={uri:a[e].__deferred.uri,dataClass:j[e].getRelatedClass(),attr:e},o.addFrameworkMethodsToNestedCollection(b[e])),b[e]&&(b[e].$_collection=b.$_entity[e])):"relatedEntity"===j[e].kind&&(b[e]=new(g[k&&a[e].relEntity?a[e].relEntity.getDataClass().$name:d[c.$name].$attr(e).type]),k&&null!==a[e].relEntity?q(a[e].relEntity,b[e],a[e].relEntity.getDataClass()):q(a[e],b[e],d[d[c.$name].$attr(e).type]))}},r=function(){console.log("$upload not yet implemented")},s=function(a,b,c){"undefined"==typeof a.$query&&(a.$query={}),a.$query.pageSize=b,a.$query.start=c},t=function(b,c){console.warn("This method is currently under refactoring");var d=this,e=a.defer(),f={};return c="undefined"==typeof c||"replace"===c?"replace":c,d.$_collection?(b||(b={}),"undefined"!=typeof b.orderBy&&console.warn("orderBy can't be change on a $fetch (nested query collection's cached on server side in some way)"),"undefined"!=typeof b.select&&console.warn("select can't be change on a $fetch (query collection's cached on server side in some way)"),f.skip=b.start="undefined"==typeof b.start?this.$query?this.$query.start:0:b.start,f.top=b.pageSize="undefined"==typeof b.pageSize?this.$query?this.$query.pageSize:h:b.pageSize,b.select&&(f.autoExpand=b.select),b.orderBy&&(f.orderby=b.orderBy),k(function(){d.$fetching=!0}),console.log(">$fetch on nestedCollection","options",b),f.onSuccess=function(a){console.log("$fetchOnNestedCollection > onSuccess","e",a),k(function(){"replace"===c&&(d.length=0),a.entityCollection.forEach({onSuccess:function(a){k(function(){console.log(a.position,a.entity,d.$_collection.relEntityCollection.getDataClass()),d.push(d.$_collection.relEntityCollection.getDataClass().$create(a.entity))})},atTheEnd:function(a){console.log("atTheEnd","e",a)},first:f.skip,limit:f.skip+f.top}),delete d.$_deferred,s(d,b.pageSize,b.start),d.$totalCount=a.entityCollection.length,d.$fetching=!1,e.resolve(d)})},f.onError=function(a){k(function(){console.error("$fetch (nestedEntities) ) > onError",a),d.$fetching=!1,e.reject(a)})},console.log("wakOptions",f),d.$_collection.getValue(f)):(e.reject("Missing $_collection private pointer (WAF.EntityAttributeRelatedSet), check if you used $find or $fetch to load the collection"),console.warn("Missing $_collection private pointer (WAF.EntityAttributeRelatedSet), check if you used $find or $fetch to load the collection")),e.promise};$$isLoadedOnNestedCollection=function(){return this.$_deferred?!1:!0};var u=function(a,b,c,d){"undefined"==typeof a.$query&&(a.$query={}),a.$query.pageSize=b,a.$query.start=c,a.$query.filter=d?d:a.$query.filter},v=function(b,c){var d,e,f,g={},h=this;if(c="undefined"==typeof c||"replace"===c?"replace":c,b||(b={}),"undefined"!=typeof b.orderBy)throw new Error("orderBy can't be change on a $fetch (query collection's cached on server side)");if("undefined"!=typeof b.select)throw new Error("select can't be change on a $fetch (query collection's cached on server side)");e=b.start="undefined"==typeof b.start?this.$query.start:b.start,f=b.pageSize=b.pageSize||this.$query.pageSize,b.params&&(g.params=b.params),d=a.defer();var h=this;return k(function(){h.$fetching=!0}),g.onSuccess=function(a){k(function(){if(o.fetchEventToNgWakEntityCollection(a),"replace"===c){h.length=0;for(var f=0;f<a.result.length;f++)h[f]=a.result[f]}else if("append"===c)for(var f=0;f<a.result.length;f++)h.push(a.result[f]);u(h,b.pageSize||h.$_collection._private.pageSize,e),h.$fetching=!1,d.resolve(a)})},g.onError=function(a){k(function(){console.error("$fetch > getEntities > onError",a),h.$fetching=!1,d.reject(a)})},this.$_collection.getEntities(e,f,g),d.promise};$$toJSON=function(){var a=function(b){var c,d,e;if(b instanceof Array){if(c=[],b.length>0)for(e=0;e<b.length;e++)c.push(a(b[e]))}else{c={};for(d in b)b.hasOwnProperty(d)&&"$_entity"!==d&&"$_deferred"!==d&&(b[d]instanceof Array||b[d]instanceof D?c[d]=a(b[d]):null===b[d]||"undefined"==typeof b[d]||b[d].$_deferred||(c[d]=b[d]))}return c},b=a(this);return JSON.stringify(b)};var w=function(){var b,c,d,e;return"undefined"!=typeof this.$query?(b=this.$query.start+this.$query.pageSize,c=this.$query.pageSize,d=this.$totalCount):(b=0,c=h,d=h),b>=d?(e=new a.defer,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c},"append")},x=function(){var b,c,d,e;return"undefined"!=typeof this.$query?(b=this.$query.start+this.$query.pageSize,c=this.$query.pageSize,d=this.$totalCount):(b=0,c=h,d=h),b>=d?(e=new a.defer,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c})},y=function(){var b,c,d;return"undefined"==typeof this.$query?(d=new a.defer,d.reject(new Error("No collection fetched to $prevPage() on.")),console.error("No collection fetched to $prevPage() on."),d.promise):(b=this.$query.start-this.$query.pageSize,c=this.$query.pageSize,0>b?(d=new a.defer,d.resolve({noMore:!0}),d.promise):this.$fetch({start:b,pageSize:c}))},z=function(){console.log("$add method not yet implemented")},A=function(b){var c,d,e,f={},h=null;return b&&"object"==typeof b||(b={}),b.select&&(f.autoExpand=b.select),b.filter&&(h=b.filter),b.params&&(f.params=b.params),b.orderBy&&(f.orderby=b.orderBy),"undefined"!=typeof b.pageSize&&(f.pageSize=b.pageSize),f.pages=b.pages,d=!!b.onlyOne,e=d?new g[this.$name]:[],c=a.defer(),e.$promise=c.promise,k(function(){e.$fetching=!0}),f.onSuccess=function(a){k(function(){o.queryEventToNgWakEntityCollection(a,d),o.asyncResult(a.result,e,c.promise),d===!1&&u(e,e.$_collection._private.pageSize,0,h),e.$fetching=!1,c.resolve(a)})},f.onError=function(a){k(function(){console.error("$find > query > onError",a),e.$fetching=!1,c.reject(a)})},b=null,this.query(h,f),e},B=function(a,b){return b="undefined"==typeof b?{}:b,b.filter="ID = "+a,b.onlyOne=!0,this.$find(b)},C={$save:function(){console.group("$save");var b,c={},d=this;return this.$syncPojoToEntity(),b=a.defer(),c.onSuccess=function(a){k(function(){console.log("save.onSuccess","event",a),d.$syncEntityToPojo(),b.resolve(a)})},c.onError=function(a){k(function(){console.error("save.onError","error",a),b.reject(a)})},this.$_entity.save(c),console.groupEnd(),b.promise},$remove:function(){console.group("$remove");var b,c={};return b=a.defer(),c.onSuccess=function(a){k(function(){console.log("remove.onSuccess","event",a),b.resolve(a)})},c.onError=function(a){k(function(){console.error("remove.onError","error",a),b.reject(a)
})},this.$_entity.remove(c),console.groupEnd(),b.promise},$syncPojoToEntity:function(){console.group("$syncPojoToEntity");var a,b=this;if(b.$_entity&&b.$_entity._private&&b.$_entity._private.values)for(a in b.$_entity._private.values)b.$_entity[a].getValue()!==b[a]&&b.$_entity[a]instanceof f.EntityAttributeSimple&&b.$_entity[a].setValue(b[a]);console.groupEnd()},$syncEntityToPojo:function(){var a,b=this;if(b.$_entity&&b.$_entity._private&&b.$_entity._private.values)for(a in b.$_entity._private.values)b.$_entity[a].getValue()!==b[a]&&b.$_entity[a]instanceof f.EntityAttributeSimple&&(b[a]=b.$_entity[a].getValue())},$fetch:function(){var b,d,e=this,f={};if(b=a.defer(),this.$_entity)return f.onSuccess=function(a){k(function(){d=e.$_entity.getDataClass().$create(a.entity);for(var c in d)d.hasOwnProperty(c)&&(e[c]=d[c]);b.resolve(d)})},f.onError=function(a){k(function(){console.error("$fetch > Error while serverRefresh",a),b.reject("$fetch > Error while serverRefresh"+a)})},this.$_entity.serverRefresh(f),b.promise;if(!this.$_deferred)throw new Error("Couldn't fetch, an error occured, no $_entity or $_deferred");return c({method:"GET",url:this.$_deferred.uri}).success(function(a){d=e.$_deferred.dataClass.$create(a);for(var c in d)d.hasOwnProperty(c)&&(e[c]=d[c]);delete e.$_deferred,b.resolve(d)}).error(function(a,c){console.error("$fetch > Error while fetching deferred entity",a,"status",c),b.reject("$fetch > Error while fetching deferred entity"+a)}),b.promise},$isLoaded:function(){return this.$_entity?!0:!1},$toJSON:$$toJSON},D=e.extend(C),E=function(b,c){var d,e={};return d=a.defer(),e.onSuccess=function(a){d.resolve({result:a.result})},e.onError=function(a){d.reject(a)},f.directory.loginByPassword(b,c,e),d.promise},F=function(){var b,c={};return b=a.defer(),c.onSuccess=function(a){b.resolve({result:a.result})},c.onError=function(a){b.reject(a)},f.directory.currentUser(c),b.promise},G=function(){var b,c={};return b=a.defer(),c.onSuccess=function(a){b.resolve({result:a.result})},c.onError=function(a){console.error(">logout",a),b.reject(a)},f.directory.logout(c),b.promise},H=function(b){var c,d={};return c=a.defer(),d.onSuccess=function(a){c.resolve({result:a.result})},d.onError=function(a){c.reject(a)},f.directory.currentUserBelongsTo(b,d),c.promise};return{init:i,getDatastore:j,$login:E,$loginByPassword:E,$currentUser:F,$logout:G,$currentUserBelongsTo:H}}])}({},function(){return this}());